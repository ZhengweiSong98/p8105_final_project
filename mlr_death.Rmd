---
title: "Logistic Hospitality"
output: 
  html_document: 
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)
library(performance)
library(see)
library(ggplot2)
library(corrplot)
library(scales)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## Data Importing
```{r warning = F, message = F}
demo_raw = read_csv("./data/Demo.csv") %>%
    janitor::clean_names() %>%
    filter(!area %in% c("Unknown", "Out of state")) %>%
    select(area, population, total_tests, reported_deaths) %>%
    group_by(area) %>%
    summarize(
        population = max(population),
        total_tests = sum(total_tests,na.rm = T),
        reported_deaths = sum(reported_deaths)
        )

head(demo_raw)
```

* The data includes `r nrow(demo_raw)` observations and `r ncol(demo_raw)` variables. Now we are interested on whether the death cases are associated with `area`, `population` and `testing_cases`.

## Data description
```{r warning = F, message = F, fig.width = 16, fig.height = 10}
point <- format_format(big.mark = " ", decimal.mark = ",", scientific = FALSE)
rawplot_death = demo_raw %>%
    ggplot(aes(x = reported_deaths)) +
    geom_density(fill = "#69b3a2", color = "#e9ecef", alpha = .8) +
    scale_y_continuous(labels = point)

rawplot_death_population = demo_raw %>%
    ggplot(aes(x = population)) +
    geom_density(fill = "#69b3a2", color = "#e9ecef", alpha = .8) +
    scale_y_continuous(labels = point) +
    scale_x_continuous(labels = point)

rawplot_death_tests = demo_raw %>%
    ggplot(aes(x = total_tests)) +
    geom_density(fill = "#69b3a2", color = "#e9ecef", alpha = .8) +
    scale_y_continuous(labels = point) +
    scale_x_continuous(labels = point)

demo_death = demo_raw %>% 
    mutate(ln_population = log(population + 0.01),
           ln_total_tests = log(total_tests + 0.01),
           ln_reported_deaths = log(reported_deaths + 0.01)) %>%
    dplyr::select(-population,-total_tests,-reported_deaths) %>%
    relocate(ln_reported_deaths)

plot_death = demo_death %>%
    ggplot(aes(x = ln_reported_deaths)) +
    geom_density(fill = "#69b3a2", color = "#e9ecef", alpha = .8)

plot_death_population = demo_death %>%
    ggplot(aes(x = ln_population)) +
    geom_density(fill = "#69b3a2", color = "#e9ecef", alpha = .8)

plot_death_tests = demo_death %>%
    ggplot(aes(x = ln_total_tests)) +
    geom_density(fill = "#69b3a2", color = "#e9ecef", alpha = .8)

(rawplot_death + rawplot_death_population + rawplot_death_tests)/(plot_death + plot_death_population + plot_death_tests)

demo_death %>%
    select(-area) %>%
    gtsummary::tbl_summary() %>%
    gtsummary::bold_labels() %>%
    as.tibble() %>% 
    knitr::kable()
```

* The cleaned data includes `r nrow(demo_death)` states and `ncol(demo_death)` including `r names(demo_death)`. The data is extremely right-skewed and the natural logarithms are applied to each explortory continuous variables.

## Correlation
```{r warning = F, message = F}
demo_death %>% 
    select(-area) %>%
    GGally::ggpairs()
```

* The correlation between predictors are highly correlated, which is more than 0.95. This is because testing count may associate with population in the area empirically.

## Modelling Fit
```{r warning = F, message = F}
reg_full = lm(ln_reported_deaths ~ ln_population*ln_total_tests, data = demo_death)

summary(reg_full)
```

* As the interaction term has p-value < 0.05, we can conclude that ln(population) and ln(total_tests) have significant interaction at 0.05 significance level, hence the two variables will be included in the model with the interaction term.

## Modelling Diagnosis & Weighted Least Squares Regression
```{r warning = F, message = F, fig.height = 10, fig.width = 10}
sd_function <- lm(abs(reg_full$residuals) ~ reg_full$fitted.values)

var_fitted <- sd_function$fitted.values^2

wt <- 1/var_fitted

wls_death <- lm(ln_reported_deaths ~ ln_population*ln_total_tests, data = demo_death, weights = wt)

summary(wls_death)

check_model(reg_full, check = c("linearity", "qq", "normality", "outliers", "homogeneity", "vif"))
check_model(wls_death, check = c("linearity", "qq", "normality", "outliers", "homogeneity", "vif"))

```

* Ordinary Least Squares violates normal assumption
* The coefficient estimate for the `ln_population` predictor variable changed somewhat and the model fit improved.
* The residual standard error changed from 9.224 (in the simple linear regression model) to 1.199 in the weighted LS model. This shows that the predictions ffrom the WLS model are much closer to the actual observations than those from the ordinary LS model.
* R-squared improved in the WLS model. WLS model is able to explain more of the variation in exam scores compared to the OLS model.
