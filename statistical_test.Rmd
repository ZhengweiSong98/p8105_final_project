---
title: "Statistical test"
output: 
  html_document: 
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r}
library(readr)
library(tidyr)
library(tidyverse)
```
```{r}
source("data_preprocessing_backbone.R")
labor_data = read_csv("./data/CA_Labor.csv") %>%
    janitor::clean_names() %>%
    dplyr::select(-employment,-unemployment,-rank) %>%
    rename(unemployment=unemployment_rate_per_cent)

population_data = read_csv("./data/CA_Land_Area.csv") %>%
    janitor::clean_names() %>%
    dplyr::select(-rank, -state) %>%
    mutate(
        location = ifelse(county %in% c("Los Angeles", "Orange", "San Diego", "Monterey", "San Benito", "San Luis Obispo", "Santa Barbara", "Santa Cruz", "Ventura", "Alameda", "Contra Costa", "Marin", "Napa", "San Francisco", "San Mateo", "Santa Clara", "Solano", "Sonoma", "Del Norte", "Humboldt", "Mendocino"), "costal", "inland")) 

geo_data = read_csv("./data/ca_boundaries.csv") %>%
    janitor::clean_names() %>%
    dplyr::select(name, intptlat, intptlon) %>%
    rename(county=name)

ca_joining_data = left_join(population_data, labor_data, by = c("county"))
ca_nonmedical_data = left_join(ca_joining_data, geo_data, by = c("county"))

ca_nonmedical_data = ca_nonmedical_data %>%
    mutate(labor_rate = labor_force/population*100) %>%
    dplyr::select(-labor_force)

demo_covid = demo %>%
    mutate(cumulative_deaths= as.numeric(population),
           cumulative_cases = as.numeric(cumulative_cases),
        prevalence=cumulative_cases/population*100,
        test = cumulative_total_tests/population*100,
        ) %>%
    dplyr::select(county_name, prevalence, test, population) %>%
    rename(county=county_name) %>%
    group_by(county) %>%
    summarize(prevalence=max(prevalence),
              test = max(test)) %>%
    filter(!county %in% c("Out of state","Unknown"))

vaccine = read_csv("./data/CA_covid19vaccines.csv") %>%
    janitor::clean_names() %>%
    group_by(county) %>%
    summarise(
        fully_vaccinated = sum(fully_vaccinated)
        # total number of fully vaccinated people
            ) %>%
    arrange(county) %>%
    drop_na() %>%
    filter(!county %in% c("Unknown", "All CA Counties", "All CA and Non-CA Counties"))

ca_medical_data = left_join(demo_covid, vaccine, by =c("county"))
ca_premodel_data = left_join(ca_medical_data, ca_nonmedical_data, by = c("county")) %>%
    mutate(
        vaccination=fully_vaccinated/population*100) %>%
    dplyr::select(-fully_vaccinated)
ca_model_data = ca_premodel_data %>% 
    mutate(ln_unemployment = log(unemployment),
           ln_area = log(land_area_sq_mi),
           ln_population = log(population),
           ln_test = log(test)) %>%
    dplyr::select(-unemployment,-land_area_sq_mi,-population,-test,-intptlat,-intptlon,-county)

```

We apply ANOVA test to our linear regression, uses the F-test to determine whether the variables fits the data as well as our model. If that F-statics are sufficiently large, or P-values are significantly smallï¼Œthen we can conclude that your model fits the data better than the intercept-only model. 

ANOVA test for model $$ln(reported \ death) = ln(population)\beta_{ln(population)} \times total \ cost\beta_{totol \ test} + \epsilon_i$$

Then, we conduct a hypothesis test.

$$H_0 = \beta_{ln(population)} = \beta_{totol \ test}$$
$$H_1 = At\ least\ one\ \beta\: is\ not\ zero $$

```{r}
demo_raw = read_csv("./data/Demo.csv") %>%
    janitor::clean_names() %>%
    filter(!area %in% c("Unknown", "Out of state")) %>%
    select(area, population, total_tests, reported_deaths) %>%
    group_by(area) %>%
    summarize(
        population = max(population),
        total_tests = sum(total_tests,na.rm = T),
        reported_deaths = sum(reported_deaths)
        )
demo_death = demo_raw %>% 
    mutate(ln_population = log(population + 0.01),
           ln_total_tests = log(total_tests + 0.01),
           ln_reported_deaths = log(reported_deaths + 0.01)) %>%
    dplyr::select(-population,-total_tests,-reported_deaths) %>%
    relocate(ln_reported_deaths)

reg_full = lm(ln_reported_deaths ~ ln_population*ln_total_tests, data = demo_death)
aov(reg_full) %>% summary()
```


ANOVA test for model $$Prevalence = location\beta_{location}+ln(test)\beta_{ln(test)}+ln(unemployment)\beta_{ln(unemployment)}+ln(area)\beta_{ln(area)}+ln(population)\beta_{ln(population)}+ \epsilon_i$$

Then, we conduct a hypothesis test.

$$H_0 = \beta_{location}+\beta_{ln(test)}+\beta_{ln(unemployment)}+\beta_{ln(area)}+\beta_{ln(population)}$$
$$H_1 = At\ least\ one\ \beta\: is\ not\ zero $$
```{r}
mlr_model = lm(prevalence~location+ln_test+ln_unemployment+ln_area+ln_population,data = ca_model_data)
aov(mlr_model) %>% summary()
```


