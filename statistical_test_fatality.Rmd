---
title: "Statistical test: fatality"
output: 
  html_document: 
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
library(readr)
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
```
```{r, include=FALSE}
source("data_preprocessing_backbone.R")
labor_data = read_csv("./data/CA_Labor.csv") %>%
    janitor::clean_names() %>%
    dplyr::select(-employment,-unemployment,-rank) %>%
    rename(unemployment=unemployment_rate_per_cent)

land_data = read_csv("./data/CA_Land_Area.csv") %>%
    janitor::clean_names() %>%
    mutate(
        location = ifelse(county %in% c("Los Angeles", "Orange", "San Diego", "Monterey", "San Benito", "San Luis Obispo", "Santa Barbara", "Santa Cruz", "Ventura", "Alameda", "Contra Costa", "Marin", "Napa", "San Francisco", "San Mateo", "Santa Clara", "Solano", "Sonoma", "Del Norte", "Humboldt", "Mendocino"), "costal", "inland")) %>%
    dplyr::select(-rank, -state, -population)

ca_nonmedical_data = left_join(land_data, labor_data, by = c("county"))

demo_covid = demo %>%
     mutate(cumulative_reported_deaths= as.numeric(cumulative_reported_deaths),
            cumulative_cases = as.numeric(cumulative_cases),
        death_rate = 0.01+cumulative_reported_deaths/population*100,
        test = cumulative_total_tests/population*100) %>%
    dplyr::select(county_name, death_rate, test,population) %>%
    rename(county=county_name) %>%
    group_by(county) %>%
    summarize(death_rate=max(death_rate,na.rm = T),
              test = max(test),
              population = max(population)) %>%
    filter(!county %in% c("Out of state","Unknown"))

vaccine = read_csv("./data/CA_covid19vaccines.csv") %>%
    janitor::clean_names() %>%
    group_by(county) %>%
    summarise(
        fully_vaccinated = sum(fully_vaccinated)
        # total number of fully vaccinated people
            ) %>%
    arrange(county) %>%
    drop_na() %>%
    filter(!county %in% c("Unknown", "All CA Counties", "All CA and Non-CA Counties","Outside California"))

hospital = read_csv("./data/CA_Covid19_Hospital.csv") %>%
    group_by(county) %>%
    summarize(all_hospital_beds = max(all_hospital_beds,na.rm = T),
              icu_available_beds = max(icu_available_beds,na.rm = T)) %>%
    dplyr::select(county, all_hospital_beds, icu_available_beds)

ca_medical_data = left_join(demo_covid, vaccine, by =c("county"))
ca_medical_data2 = left_join(ca_medical_data, hospital, by =c("county"))
ca_premodel_data = left_join(ca_medical_data2, ca_nonmedical_data, by = c("county")) %>%
    relocate(death_rate) %>%
    mutate(
        vaccinated=fully_vaccinated/population*100,
        labor_rate = labor_force/population*100,
        hospital_bed = all_hospital_beds/population*100,
        icu_bed = icu_available_beds/population*100
    )%>%
    dplyr::select(-fully_vaccinated, -population, -labor_force,-all_hospital_beds,-icu_available_beds)

ca_model_data = ca_premodel_data %>% 
    mutate(ln_tests = log(test),
           ln_area = log(land_area_sq_mi),
           ln_unemployment = log(unemployment),
           ln_hospital = log(hospital_bed+0.01),
           ln_bed = log(icu_bed+0.01)
           ) %>%
    dplyr::select(-test,-land_area_sq_mi,-unemployment,-county,-hospital_bed,-icu_bed) %>%
    filter(!ln_hospital %in% NA,
           !ln_bed %in% NA)

```

For ferality model, the test assumptions for ANOVA test are [checked](mlr_fatality.html)
ANOVA test for model $$death\ rate = location\beta_{location}+vaccinated\beta_{vaccinated}+labor\ rate\beta_{labor\ rate}+ln(tests)\beta_{ln(test)}+ln(area)\beta_{ln(area)}+ln(unemployment)\beta){ln(unemployment)}+ln(bed)\beta_{ln(bed)}+\epsilon_i$$

Then, we conduct a hypothesis test for fatality.

$$H_0 = \beta_{location}=\beta_{vaccinated}=\beta_{labor\ rate}=\beta_{ln(test)}=\beta_{ln(area)}=\beta_{ln(unemployment)}=\beta_{ln(bed)}$$
$$H_1 = At\ least\ one\ \beta\: is\ not\ zero $$
```{r}
mlr_model = lm(death_rate~location+vaccinated+labor_rate+ln_tests+ln_area+ln_unemployment+ln_bed,data = ca_model_data)
anova(mlr_model) %>% broom::tidy()
```
From the table above, we can see that the variables, such as $location$,$labor\ rate$,$ln(tests)$,$ln(area)$,$ln(unemployment)$,$ln(bed)$ are statistically significant, which means their p-value smaller than 0.05. Only variable $vaccinated$ has p-value greater than 0.05. This is because of the effect of Collinearity. Since $vaccinated$ is closely related to the $death\ rate$. Thus, we decide to keep variable $vaccinated$ in our model.
